<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Dashboard | NW Guitars POS</title>
        <link href="/lib/bootstrap-5.3.0-alpha1-dist/css/bootstrap.min.css" rel="stylesheet" />
        <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <link href="/css/app.css" rel="stylesheet" />
    </head>
    <body>
        <main class="p-4" id="dashboard">
            <nav class="navbar navbar-expand-lg fixed-top bg-body-tertiary shadow-sm">
                <div class="container">
                    <a class="navbar-brand" href="/views/index.html">POS Dashboard</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="page" href="/views/index.html">Inventory</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="/views/orders.html">Orders</a>
                            </li>
                        </ul>
                    </div>
                    <span class="navbar-text px-2">
                        Last sync: <strong x-data x-text="$store.lastSync"></strong>
                    </span>
                    <button x-data @click="sync()" class="btn btn-outline-primary" :disabled="$store.isSyncing">
                        Sync now
                        <div class="spinner-border spinner-border-sm" x-show="$store.isSyncing" role="status"></div>
                    </button>
                </div>
            </nav>

            <div class="container mt-auto pt-4">

                <div class="row py-6">
                    <div class="col-7">
                        <h1 class="text-start">Inventory</h1>
                    </div>
                    <div class="col-2">
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col">
                        <h5>Filters</h5>
                    </div>
                </div>
                <div class="row" x-data="{
                    barcode: '',
                    sku: '',
                }">
                    <div class="col-3">
                        <div class="input-group mb-3">
                            <input x-model="sku" type="text" class="form-control" placeholder="SKU" aria-label="SKU" aria-describedby="btn-filter-sku">
                            <button @click="filterBySku($data.sku)" class="btn btn-outline-secondary" type="button" id="btn-filter-sku">Filter</button>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="input-group mb-3">
                            <input x-model="barcode" type="text" class="form-control" placeholder="Barcode" aria-label="Barcode" aria-describedby="btn-filter-barcode">
                            <button @click="filterByBarcode($data.barcode)" class="btn btn-outline-secondary" type="button" id="btn-filter-barcode">Filter</button>
                        </div>
                    </div>
                    <div class="col-1">
                        <button
                            @click="clearFilters"
                            x-show="$data.sku.length > 0 || $data.barcode.length > 0"
                            class="btn btn-outline-danger">Clear</button>
                    </div>
                    <div class="col-5">
                        <p class="text-end">Total Items: <span x-text="$store.filtered.length"></span></p>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col">
                        <table class="table table-striped" x-data x-show="$store.inventory.length > 0" x-animate>
                            <thead>
                                <tr>
                                    <th scope="col">Linnworks</th>
                                    <th scope="col">Square</th>
                                    <th scope="col">Title</th>
                                    <th scope="col">Barcode</th>
                                    <th scope="col">SKU</th>
                                    <th scope="col">Price</th>
                                    <th scope="col">Category</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="item in $store.filtered">
                                    <tr>
                                        <td> 
                                            <div class="d-flex">
                                                <span x-text="short(item.linnworksId)" class="fw-semibold"></span>
                                                <a @click="navigator.clipboard.writeText(item.linnworksId)" href="#" class="px-2">
                                                    <img src="/img/copy.svg" width="11px" /> 
                                                </a>
                                            </div>
                                        </td>
                                        <td> 
                                            <div class="d-flex">
                                                <span x-text="short(item.squareId)" class="fw-semibold"></span>
                                                <a @click="navigator.clipboard.writeText(item.squareId)" href="#" class="px-2">
                                                    <img src="/img/copy.svg" width="11px" /> 
                                                </a>
                                            </div>
                                        </td>
                                        <td x-text="item.title"></td>
                                        <td x-text="item.barcode"></td>
                                        <td x-text="item.sku"></td>
                                        <td x-text="price(item.price)"></td>
                                        <td x-text="item.categoryName"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>

                        <p  x-data="{}" 
                            x-show="$store.inventory.length === 0"
                            class="placeholder-glow">
                            <span class="placeholder col-12 placeholder-lg"></span>
                            <template x-for="_ in 50">
                                <span class="placeholder col-12 placeholder bg-secondary"></span>
                            </template>
                        </p>


                        <p x-data x-show="$store.inventory.length > 0" class="text-center py-4">
                            Wow, you reached the bottom ðŸ˜². 
                            Click the wee finger to back to the top <a href="#">ðŸ‘†</a>
                        </p>

                    </div>
                </div>
            </div>
        </main>

    </body>

    <script type="text/javascript" src="/js/functions.js"></script>
    <script type="text/javascript">

        const AUTH_FAILED_MSG = 'auth failed'

        document.addEventListener('alpine:init', () => {
            Alpine.store('inventory', [])
            Alpine.store('lastSync', '')
            Alpine.store('isSyncing', false)

            let jwt = localStorage.getItem("jwt")
            if (!jwt) {
                goToAuthPage()
                return
            }
            Alpine.store('jwt', jwt)

            fetchHttp('/api/v1/inventory', jwt)
                .then(data => {
                    if(data.Message && data.Message == AUTH_FAILED_MSG) {
                        goToAuthPage()
                        return
                    } else if(!data.items) {
                        console.log(data.Message)
                        return
                    }

                    Alpine.store('inventory', data.items)
                    Alpine.store('filtered', data.items)
                });

            fetchHttp('/api/v1/sync/status', jwt)
                .then(data => Alpine.store('lastSync', df(data.ts)))
        })

        function filterBySku(sku) {
            let items = Alpine.store('inventory')
            sku.length === 0 ?
                Alpine.store('filtered', items) :
                Alpine.store('filtered', items.filter(item => item.sku === sku))
        }

        function filterByBarcode(barcode) {
            let items = Alpine.store('inventory')
            barcode.length === 0 ?
                Alpine.store('filtered', items) :
                Alpine.store('filtered', items.filter(item => item.barcode === barcode))
        }

        function clearFilters() {
            Alpine.store('filtered', Alpine.store('inventory'))
        }

    </script>

</html>
